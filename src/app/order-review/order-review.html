<!-- BREADCRUMB -->
<nav class="breadcrumb-bar py-2">
  <div class="container">
    <ol class="breadcrumb mb-0">
      <li class="breadcrumb-item"><a routerLink="/">Trang chủ</a></li>
      <!-- ✅ Dùng (click) thay vì routerLink tĩnh để truyền đúng productId -->
      <li class="breadcrumb-item">
        <a style="cursor:pointer;" (click)="goToProduct()">{{ productName || 'Sản phẩm' }}</a>
      </li>
      <li class="breadcrumb-item active">Đánh giá sản phẩm</li>
    </ol>
  </div>
</nav>

<!-- THÔNG BÁO CHƯA CÓ productId -->
<div class="container py-5 text-center" *ngIf="!productId">
  <i class="bi bi-chat-square-text fs-1 text-secondary d-block mb-3"></i>
  <p class="text-secondary">Vui lòng mở trang này từ một sản phẩm cụ thể.</p>
  <a class="btn-reset" routerLink="/product-listing-page">Xem sản phẩm</a>
</div>

<div class="container py-4" style="background:#FAF6F0; max-width:100%;" *ngIf="productId">
  <div class="container">
    <div class="d-flex flex-column gap-4">

      <!-- TỔNG QUAN -->
      <div class="review-summary-card p-4">
        <div class="row g-4 align-items-center">
          <div class="col-12 col-md-3 text-center border-end">
            <div class="score-big">{{ averageRating | number:'1.1-1' }}</div>
            <div class="score-stars mb-1">{{ starsDisplay }}</div>
            <div class="score-meta">{{ totalReviews }} đánh giá · {{ totalSold }} đã mua</div>
          </div>
          <div class="col-12 col-md-5">
            <div class="d-flex flex-column gap-2">
              <div class="d-flex align-items-center gap-2" *ngFor="let s of [5, 4, 3, 2, 1]">
                <span class="bar-label">{{ s }}</span>
                <div class="bar-track flex-grow-1">
                  <div class="bar-fill" [style.width.%]="getBarPercent(s)"></div>
                </div>
                <span class="bar-count">{{ ratingCounts[s] }}</span>
              </div>
            </div>
          </div>
          <div class="col-12 col-md-4">
            <div class="highlight-title mb-2">Khách hàng thường khen</div>
            <div class="d-flex flex-wrap gap-2" *ngIf="praiseTags.length > 0">
              <span class="highlight-tag" *ngFor="let tag of praiseTags">{{ tag }}</span>
            </div>
            <p class="text-secondary" style="font-size:13px;" *ngIf="praiseTags.length === 0">
              Chưa có đủ đánh giá để tổng hợp.
            </p>
          </div>
        </div>
      </div>

      <!-- VIẾT ĐÁNH GIÁ -->
      <div class="write-review-card p-4" *ngIf="isLoggedIn">
        <div class="write-title mb-4">Chia sẻ trải nghiệm của bạn</div>
        <div class="mb-3">
          <div class="write-label mb-2">Đánh giá sao <span class="required">*</span></div>
          <div class="d-flex align-items-center gap-1">
            <button class="star-btn"
              *ngFor="let s of [1, 2, 3, 4, 5]"
              [class.active]="s <= (hoverStar || selectedStar)"
              (mouseenter)="hoverStar = s"
              (mouseleave)="hoverStar = 0"
              (click)="selectedStar = s">&#9733;</button>
            <span class="star-hint ms-2" *ngIf="selectedStar > 0">{{ starLabels[selectedStar] }}</span>
          </div>
        </div>
        <div class="mb-3" *ngIf="purchasedVariants.length > 0">
          <div class="write-label mb-2">Bạn đã mua loại nào?</div>
          <div class="d-flex flex-wrap gap-2">
            <button class="variant-chip"
              *ngFor="let v of purchasedVariants"
              [class.active]="selectedVariant === v"
              (click)="selectedVariant = v">{{ v }}</button>
          </div>
        </div>
        <div class="mb-3">
          <div class="write-label mb-2">Nhận xét chi tiết <span class="required">*</span></div>
          <textarea class="review-textarea"
            [(ngModel)]="reviewText"
            placeholder="Chia sẻ cảm nhận: chất lượng, mùi vị, đóng gói..."
            maxlength="500" rows="4"></textarea>
          <div class="char-count">{{ reviewText.length }}/500</div>
        </div>
        <div class="mb-3">
          <div class="write-label mb-2">Chọn nhanh từ khóa</div>
          <div class="d-flex flex-wrap gap-2">
            <button class="quick-tag"
              *ngFor="let tag of quickTags"
              [class.active]="isTagSelected(tag)"
              (click)="toggleQuickTag(tag)">{{ tag }}</button>
          </div>
        </div>
        <div class="mb-4">
          <div class="write-label mb-2">Thêm hình ảnh thực tế</div>
          <div class="upload-area" (click)="fileInput.click()">
            <i class="upload-icon bi bi-camera"></i>
            <span class="upload-label">Thêm ảnh sản phẩm thực tế (tối đa 5 ảnh)</span>
            <span class="upload-hint">JPG, PNG · Tối đa 5MB/ảnh</span>
          </div>
          <input type="file" #fileInput accept="image/*" multiple hidden (change)="onFileSelected($event)" />
        </div>
        <div class="d-flex align-items-center gap-3">
          <button class="btn-submit-review"
            [class.ready]="canSubmit()"
            [disabled]="!canSubmit()"
            (click)="submitReview()">
            {{ isSubmitting ? 'Đang gửi...' : 'Gửi đánh giá' }}
          </button>
          <span class="submit-hint" *ngIf="!canSubmit()">Vui lòng chọn số sao và nhập nhận xét</span>
        </div>
      </div>

      <!-- ĐĂNG NHẬP -->
      <div class="login-prompt-card p-4 d-flex align-items-center gap-3" *ngIf="!isLoggedIn">
        <i class="bi bi-lock-fill fs-2 text-secondary"></i>
        <div class="flex-grow-1">
          <strong class="d-block mb-1" style="color:#2D5016;">Đăng nhập để đánh giá sản phẩm</strong>
          <span style="font-size:13px;color:#8A9E72;">Chỉ những khách hàng đã mua sản phẩm mới có thể để lại đánh giá.</span>
        </div>
        <button class="btn-login-now" routerLink="/user-authentication">Đăng nhập ngay</button>
      </div>

      <!-- BỘ LỌC -->
      <div class="review-filter-bar p-3 d-flex flex-wrap align-items-center gap-2">
        <button class="review-filter-btn" [class.active]="activeFilter === 'all'" (click)="setFilter('all')">
          Tất cả ({{ totalReviews }})
        </button>
        <button class="review-filter-btn"
          *ngFor="let s of [5, 4, 3, 2, 1]"
          [class.active]="activeFilter === s.toString()"
          (click)="setFilter(s.toString())">
          {{ s }} sao ({{ ratingCounts[s] }})
        </button>
        <button class="review-filter-btn" [class.active]="activeFilter === 'photo'" (click)="setFilter('photo')">
          <i class="bi bi-camera me-1"></i>Có ảnh ({{ photoReviewCount }})
        </button>
        <div class="ms-auto">
          <select class="sort-select" [(ngModel)]="reviewSort" (change)="onSortChange()">
            <option value="newest">Mới nhất</option>
            <option value="highest">Đánh giá cao</option>
            <option value="lowest">Đánh giá thấp</option>
            <option value="helpful">Hữu ích nhất</option>
          </select>
        </div>
      </div>

      <!-- DANH SÁCH ĐÁNH GIÁ -->
      <div class="d-flex flex-column gap-3">

        <div class="review-card p-4" *ngFor="let review of filteredReviews; let i = index">
          <div class="d-flex align-items-start justify-content-between mb-3">
            <div class="d-flex align-items-center gap-3">
              <div class="reviewer-avatar" [style.background]="getAvatarColor(i)">
                {{ getAvatarInitial(review.name) }}
              </div>
              <div>
                <div class="reviewer-name">{{ review.name }}</div>
                <div class="reviewer-verified" *ngIf="review.verified">
                  <i class="bi bi-patch-check-fill me-1"></i>Đã mua hàng
                </div>
              </div>
            </div>
            <div class="text-end">
              <div class="review-stars">{{ getStarStr(review.rating) }}</div>
              <div class="review-date">{{ review.createdAt | date:'dd/MM/yyyy' }}</div>
            </div>
          </div>
          <div class="mb-2" *ngIf="review.variant">
            <span class="review-variant">Đã mua: <strong>{{ review.variant }}</strong></span>
          </div>
          <div class="d-flex flex-wrap gap-2 mb-2" *ngIf="review.tags?.length">
            <span class="review-tag" *ngFor="let tag of review.tags">{{ tag }}</span>
          </div>
          <p class="review-text mb-3">{{ review.text }}</p>
          <div class="d-flex gap-2 flex-wrap mb-3" *ngIf="review.imgs?.length">
            <div class="review-img" *ngFor="let img of review.imgs" (click)="openImageViewer(img)">
              <img [src]="img" alt="Ảnh đánh giá" />
            </div>
          </div>
          <div class="admin-reply p-3 mb-3" *ngIf="review.adminReply">
            <div class="d-flex align-items-center gap-2 mb-2">
              <span class="admin-badge">HealthUp phản hồi</span>
              <span class="admin-reply-date">{{ review.adminReplyDate }}</span>
            </div>
            <p class="admin-reply-text mb-0">{{ review.adminReply }}</p>
          </div>
          <div class="d-flex align-items-center gap-2 flex-wrap pt-3 border-top">
            <span class="helpful-text">Đánh giá này có hữu ích không?</span>
            <button class="helpful-btn" (click)="markHelpful(review._id)">
              <i class="bi bi-hand-thumbs-up"></i> Có ({{ review.helpful || 0 }})
            </button>
            <button class="helpful-btn" (click)="markNotHelpful(review._id)">
              <i class="bi bi-hand-thumbs-down"></i> Không
            </button>
            <button class="report-btn ms-auto" (click)="reportReview(review._id)">
              <i class="bi bi-flag me-1"></i>Báo cáo
            </button>
          </div>
        </div>

        <!-- SKELETON -->
        <ng-container *ngIf="isLoading">
          <div class="review-card p-4" *ngFor="let s of [1, 2]">
            <div class="skeleton-line mb-2" style="width:30%"></div>
            <div class="skeleton-line mb-2" style="width:60%"></div>
            <div class="skeleton-line mb-2" style="width:100%"></div>
            <div class="skeleton-line" style="width:80%"></div>
          </div>
        </ng-container>

        <!-- TRỐNG -->
        <div class="no-reviews-card text-center py-5 px-3"
          *ngIf="filteredReviews.length === 0 && !isLoading">
          <i class="bi bi-chat-square-text fs-1 text-secondary d-block mb-3"></i>
          <div class="no-reviews-title mb-1">Chưa có đánh giá nào</div>
          <p class="text-secondary mb-0" style="font-size:14px;">
            Hãy là người đầu tiên chia sẻ cảm nhận về sản phẩm này.
          </p>
        </div>

        <!-- TẢI THÊM -->
        <div class="text-center mt-2" *ngIf="hasMoreReviews">
          <button class="btn-load-more" (click)="loadMoreReviews()" [disabled]="isLoading">
            {{ isLoading ? 'Đang tải...' : 'Xem thêm đánh giá' }}
          </button>
        </div>

      </div>
    </div>
  </div>
</div>