<!-- LOADING STATE -->
<div class="container py-5 text-center" *ngIf="isLoading">
  <div class="spinner-border text-success" role="status">
    <span class="visually-hidden">Đang tải...</span>
  </div>
  <p class="mt-3 text-secondary">Đang tải thông tin sản phẩm...</p>
</div>

<!-- KHÔNG TÌM THẤY -->
<div class="container py-5 text-center" *ngIf="!isLoading && !product">
  <i class="bi bi-box-seam fs-1 text-secondary d-block mb-3"></i>
  <h5 class="text-secondary">Không tìm thấy sản phẩm</h5>
  <button class="btn-reset mt-3" routerLink="/product-listing-page">Quay lại danh sách</button>
</div>

<ng-container *ngIf="!isLoading && product">

<!-- BREADCRUMB -->
<nav class="breadcrumb-bar py-2">
  <div class="container">
    <ol class="breadcrumb mb-0">
      <li class="breadcrumb-item"><a routerLink="/">Trang chủ</a></li>
      <li class="breadcrumb-item"><a routerLink="/product-listing-page">{{ product.cat }}</a></li>
      <li class="breadcrumb-item active">{{ product.name }}</li>
    </ol>
  </div>
</nav>

<!-- DETAIL LAYOUT -->
<div class="container py-5" style="background:#FAF6F0; max-width:100%;">
  <div class="container">
    <div class="row g-5">

      <!-- GALLERY -->
      <div class="col-12 col-lg-5">
        <div class="position-sticky" style="top:88px;">
          <div class="gallery-main mb-3">
            <!-- ✅ activeImage đã được fix URL trong loadProduct() -->
            <img [src]="activeImage || 'assets/images/placeholder.png'" [alt]="product.name" />
          </div>
          <div class="d-flex gap-2 overflow-auto pb-1">
            <div class="gallery-thumb"
              *ngFor="let img of product.images"
              [class.active]="activeImage === img"
              (click)="activeImage = img">
              <img [src]="img" [alt]="product.name" />
            </div>
          </div>
        </div>
      </div>

      <!-- INFO -->
      <div class="col-12 col-lg-7 d-flex flex-column gap-4">

        <div>
          <div class="detail-cat mb-2">{{ product.cat }}</div>
          <h1 class="detail-title mb-0">{{ product.name }}</h1>
        </div>

        <!-- Đánh giá -->
        <div class="d-flex align-items-center gap-2 flex-wrap">
          <span class="rating-stars">{{ getStars(product.rating || 0) }}</span>
          <span class="rating-score">{{ product.rating || 0 }}</span>
          <span class="rating-meta">· {{ product.reviewCount || 0 }} đánh giá · {{ product.sold || 0 }} đã bán</span>
          <a class="rating-link ms-1"
            [routerLink]="['/order-review']"
            [queryParams]="{productId: product._id}">Xem đánh giá</a>
        </div>

        <!-- Giá -->
        <div class="d-flex align-items-baseline gap-3 flex-wrap">
          <span class="detail-price">{{ product.price | currency:'VND':'symbol':'1.0-0' }}</span>
          <span class="detail-price-old" *ngIf="product.oldPrice">
            {{ product.oldPrice | currency:'VND':'symbol':'1.0-0' }}
          </span>
          <span class="save-badge" *ngIf="product.oldPrice">
            Tiết kiệm {{ (product.oldPrice - product.price) | currency:'VND':'symbol':'1.0-0' }}
          </span>
        </div>

        <!-- Mô tả ngắn -->
        <p class="detail-desc mb-0">{{ product.shortDesc }}</p>

        <!-- Trọng lượng -->
        <div *ngIf="product.weights?.length">
          <div class="variant-label mb-2">Trọng lượng</div>
          <div class="d-flex gap-2 flex-wrap">
            <button class="variant-btn"
              *ngFor="let w of product.weights"
              [class.active]="selectedWeight === w.label"
              [class.out-of-stock]="w.outOfStock"
              (click)="!w.outOfStock && selectWeight(w.label)">
              {{ w.label }}
            </button>
          </div>
        </div>

        <!-- Loại đóng gói -->
        <div *ngIf="product.packagingTypes?.length">
          <div class="variant-label mb-2">Loại đóng gói</div>
          <div class="d-flex gap-2 flex-wrap">
            <button class="variant-btn"
              *ngFor="let t of product.packagingTypes"
              [class.active]="selectedType === t"
              (click)="selectedType = t">{{ t }}</button>
          </div>
        </div>

        <!-- Số lượng & Tồn kho -->
        <div class="d-flex align-items-center gap-3 flex-wrap">
          <span class="variant-label">Số lượng:</span>
          <div class="qty-control">
            <button class="qty-btn" (click)="decreaseQty()" [disabled]="qty <= 1">
              <i class="bi bi-dash"></i>
            </button>
            <span class="qty-value">{{ qty }}</span>
            <button class="qty-btn" (click)="increaseQty()" [disabled]="qty >= product.stock">
              <i class="bi bi-plus"></i>
            </button>
          </div>
          <span class="stock-info" [class.low]="product.stock < 10">
            <i class="bi me-1"
              [class.bi-check-circle]="product.stock >= 10"
              [class.bi-exclamation-triangle]="product.stock < 10"></i>
            Còn {{ product.stock }} sản phẩm
          </span>
        </div>

        <!-- CTA -->
        <div class="d-flex gap-3">
          <button class="btn-cart flex-grow-1" [class.added]="addedToCart" (click)="addToCart()">
            <i class="bi bi-cart3"></i>
            {{ addedToCart ? 'Đã thêm vào giỏ!' : 'Thêm vào giỏ hàng' }}
          </button>
          <button class="btn-buy flex-grow-1" (click)="buyNow()">
            <i class="bi bi-lightning-charge-fill me-1"></i>Mua ngay
          </button>
        </div>

        <!-- Yêu thích & Chia sẻ -->
        <div class="d-flex gap-2">
          <button class="btn-action" [class.wishlisted]="isWishlisted" (click)="toggleWishlist()">
            <i class="bi me-1"
              [class.bi-heart-fill]="isWishlisted"
              [class.bi-heart]="!isWishlisted"></i>
            {{ isWishlisted ? 'Đã yêu thích' : 'Yêu thích' }}
          </button>
          <button class="btn-action" (click)="share()">
            <i class="bi bi-share me-1"></i>Chia sẻ
          </button>
        </div>

        <!-- Trust Badges -->
        <div class="d-flex gap-2 flex-wrap">
          <span class="info-badge"><i class="bi bi-truck me-1"></i>Freeship từ 299K</span>
          <span class="info-badge"><i class="bi bi-arrow-repeat me-1"></i>Đổi trả 7 ngày</span>
          <span class="info-badge"><i class="bi bi-patch-check me-1"></i>VSATTP</span>
          <span class="info-badge"><i class="bi bi-box-seam me-1"></i>Đóng gói cẩn thận</span>
        </div>

        <!-- TABS -->
        <div class="detail-tabs-wrapper">
          <div class="nav-tabs-detail">
            <button class="tab-btn" [class.active]="activeTab === 'desc'"      (click)="activeTab = 'desc'">Mô tả</button>
            <button class="tab-btn" [class.active]="activeTab === 'nutrition'" (click)="activeTab = 'nutrition'">Dinh dưỡng</button>
            <button class="tab-btn" [class.active]="activeTab === 'policy'"   (click)="activeTab = 'policy'">Chính sách</button>
          </div>
          <div class="tab-content">

            <!-- Mô tả -->
            <div *ngIf="activeTab === 'desc'">
              <div class="desc-text" [innerHTML]="product.description"></div>
            </div>

            <!-- Dinh dưỡng -->
            <div *ngIf="activeTab === 'nutrition'">
              <p class="nutrition-note mb-3">Thông tin dinh dưỡng trên 100g sản phẩm</p>
              <div *ngIf="!product.nutrition?.length" class="text-secondary" style="font-size:14px;">
                Chưa có thông tin dinh dưỡng.
              </div>
              <table class="nutrition-table" *ngIf="product.nutrition?.length">
                <thead>
                  <tr>
                    <th>Thành phần</th>
                    <th>Hàm lượng</th>
                    <th>% NDH ngày</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let row of product.nutrition">
                    <td>{{ row.name }}</td>
                    <td><strong>{{ row.value }}</strong></td>
                    <td [class.high]="row.percent > 50">{{ row.percent }}%</td>
                  </tr>
                </tbody>
              </table>
              <p class="nutrition-disclaimer mt-2">* NDH = Nhu cầu dinh dưỡng hàng ngày dựa trên chế độ 2000 kcal.</p>
            </div>

            <!-- Chính sách -->
            <div *ngIf="activeTab === 'policy'">
              <div class="policy-item" *ngFor="let item of policyItems">
                <i class="policy-icon bi {{ item.icon }}"></i>
                <div>
                  <strong>{{ item.title }}</strong>
                  <p>{{ item.desc }}</p>
                </div>
              </div>
            </div>

          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- SẢN PHẨM LIÊN QUAN -->
<section class="py-5" style="background:#FAF6F0;" *ngIf="relatedProducts.length > 0">
  <div class="container">
    <h2 class="section-title mb-4">Có thể bạn cũng thích</h2>
    <div class="row g-3">
      <div class="col-6 col-md-3" *ngFor="let p of relatedProducts">
        <div class="related-product-card" (click)="goToProduct(p._id)">
          <div class="related-img">
            <!-- ✅ Dùng p.image đã fix URL -->
            <img [src]="p.image || 'assets/images/placeholder.png'" [alt]="p.name" />
          </div>
          <div class="p-3">
            <div class="product-cat mb-1">{{ p.cat }}</div>
            <div class="product-name mb-2">{{ p.name }}</div>
            <div class="d-flex align-items-center justify-content-between">
              <span class="product-price">{{ p.price | currency:'VND':'symbol':'1.0-0' }}</span>
              <button class="btn-add" (click)="addRelated($event, p._id)">
                <i class="bi bi-plus"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

</ng-container>