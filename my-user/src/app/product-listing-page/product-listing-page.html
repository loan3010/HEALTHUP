<!-- BREADCRUMB -->
<nav class="breadcrumb-bar py-2 px-0">
  <div class="container">
    <ol class="breadcrumb mb-0">
      <li class="breadcrumb-item"><a routerLink="/">Trang chủ</a></li>
      <li class="breadcrumb-item active">Sản phẩm</li>
    </ol>
  </div>
</nav>

<div class="container py-4" style="background:#FAF6F0; max-width:100%;">
  <div class="row g-4">

    <!-- SIDEBAR -->
    <div class="col-12 col-lg-3">
      <app-sidebar
        [selectedFilters]="selectedFilters"
        [priceRange]="priceRange"
        [categoryCounts]="categoryCounts"
        (allFiltersChanged)="onAllFiltersChanged($event)"
        (reset)="onResetFilters()">
      </app-sidebar>
    </div>

    <!-- PRODUCTS AREA -->
    <div class="col-12 col-lg-9">

      <!-- ACTIVE FILTER TAGS -->
      <div class="d-flex flex-wrap gap-2 align-items-center mb-3" *ngIf="activeFilterTags.length > 0">
        <span class="filter-tag" *ngFor="let tag of activeFilterTags">
          {{ tag.label }}
          <button class="tag-remove" (click)="removeFilter(tag.key)">×</button>
        </span>
        <button class="btn-clear-all" (click)="clearAllFilters()">Xóa tất cả</button>
      </div>

      <!-- RESULTS BAR -->
      <div class="results-bar d-flex align-items-center justify-content-between p-3 mb-4">
        <span class="results-count">
          Tìm thấy <strong>{{ totalProducts }}</strong> sản phẩm
        </span>
        <div class="d-flex align-items-center gap-2">
          <select class="sort-select" [(ngModel)]="sortBy" (change)="onSortChange()">
            <option value="popular">Phổ biến nhất</option>
            <option value="newest">Mới nhất</option>
            <option value="price-asc">Giá tăng dần</option>
            <option value="price-desc">Giá giảm dần</option>
            <option value="rating">Đánh giá cao</option>
          </select>
          <button class="view-btn" [class.active]="viewMode === 'grid'" (click)="viewMode = 'grid'">
            <i class="bi bi-grid"></i>
          </button>
          <button class="view-btn" [class.active]="viewMode === 'list'" (click)="viewMode = 'list'">
            <i class="bi bi-list-ul"></i>
          </button>
        </div>
      </div>

      <!-- SKELETON -->
      <div class="row g-3" *ngIf="isLoading">
        <div class="col-6 col-md-4" *ngFor="let s of skeletons">
          <div class="product-card">
            <div class="skeleton-img"></div>
            <div class="p-3 d-flex flex-column gap-2">
              <div class="skeleton-line" style="width:50%"></div>
              <div class="skeleton-line" style="width:80%"></div>
              <div class="skeleton-line" style="width:40%"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- GRID VIEW -->
      <div class="row g-3" *ngIf="viewMode === 'grid' && !isLoading">
        <div class="col-6 col-md-4" *ngFor="let p of displayedProducts">
          <div class="product-card h-100" (click)="goToDetail(p._id)">
            <div class="product-img-wrap">
              <span class="badge-new" *ngIf="p.badge === 'new'">Mới</span>
              <span class="badge-hot" *ngIf="p.badge === 'hot'">Hot</span>
              <span class="badge-sale" *ngIf="p.sale">{{ p.sale }}</span>
              <img [src]="p.image || 'assets/images/placeholder.png'" [alt]="p.name" />
              <button class="btn-wishlist"
                [class.active]="isWishlisted(p._id)"
                (click)="toggleWishlist($event, p._id)">
                <i class="bi"
                  [class.bi-heart-fill]="isWishlisted(p._id)"
                  [class.bi-heart]="!isWishlisted(p._id)"></i>
              </button>
            </div>
            <div class="p-3">
              <div class="product-cat mb-1">{{ p.cat }}</div>
              <div class="product-name mb-1">{{ p.name }}</div>
              <div class="product-weight mb-2">{{ p.weight }}</div>
              <div class="d-flex align-items-center justify-content-between pt-2 product-footer-row">
                <div>
                  <span class="product-price">{{ p.price | currency:'VND':'symbol':'1.0-0' }}</span>
                  <span class="product-price-old ms-1" *ngIf="p.oldPrice">
                    {{ p.oldPrice | currency:'VND':'symbol':'1.0-0' }}
                  </span>
                  <div class="product-rating">
                    <span class="stars">{{ getStars(p.rating || 0) }}</span>
                    <span class="ms-1">({{ p.reviewCount || p.reviews || 0 }})</span>
                  </div>
                </div>
                <button class="btn-add" (click)="addToCart($event, p._id)">
                  <i class="bi bi-plus"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- LIST VIEW -->
      <div class="d-flex flex-column gap-3" *ngIf="viewMode === 'list' && !isLoading">
        <div class="product-list-item d-flex gap-3 p-3"
          *ngFor="let p of displayedProducts"
          (click)="goToDetail(p._id)">
          <div class="list-img">
            <img [src]="p.image || 'assets/images/placeholder.png'" [alt]="p.name" />
          </div>
          <div class="flex-grow-1">
            <div class="product-cat mb-1">{{ p.cat }}</div>
            <div class="list-name mb-2">{{ p.name }}</div>
            <div class="d-flex gap-2 flex-wrap mb-2">
              <span class="chip chip-green">{{ p.weight }}</span>
              <span class="chip chip-amber" *ngIf="p.badge === 'hot'">Bán chạy</span>
              <span class="chip chip-blue"  *ngIf="p.badge === 'new'">Mới</span>
            </div>
            <div class="product-rating">
              <span class="stars">{{ getStars(p.rating || 0) }}</span>
              <span class="ms-1">{{ p.reviewCount || p.reviews || 0 }} đánh giá</span>
            </div>
          </div>
          <div class="d-flex flex-column align-items-end justify-content-between" style="min-width:130px;">
            <div class="text-end">
              <div class="product-price">{{ p.price | currency:'VND':'symbol':'1.0-0' }}</div>
              <div class="product-price-old" *ngIf="p.oldPrice">
                {{ p.oldPrice | currency:'VND':'symbol':'1.0-0' }}
              </div>
            </div>
            <button class="btn-add-list" (click)="addToCart($event, p._id)">+ Giỏ hàng</button>
          </div>
        </div>
      </div>

      <!-- EMPTY STATE -->
      <div class="empty-state text-center py-5 px-3"
        *ngIf="displayedProducts.length === 0 && !isLoading">
        <i class="bi bi-search fs-1 text-secondary d-block mb-3"></i>
        <div class="empty-title mb-2">Không tìm thấy sản phẩm</div>
        <p class="empty-desc mb-4">Thử điều chỉnh bộ lọc hoặc kiểm tra kết nối server.</p>
        <button class="btn-reset" (click)="clearAllFilters()">Xóa bộ lọc</button>
      </div>

      <!-- PAGINATION -->
      <div class="d-flex justify-content-center gap-2 mt-4" *ngIf="totalPages > 1">
        <button class="page-btn" [disabled]="currentPage === 1" (click)="changePage(currentPage - 1)">
          <i class="bi bi-chevron-left"></i>
        </button>
        <ng-container *ngFor="let p of pageNumbers">
          <span class="page-btn page-ellipsis" *ngIf="p === '...'">...</span>
          <button class="page-btn"
            *ngIf="p !== '...'"
            [class.active]="p === currentPage"
            (click)="changePage(+p)">{{ p }}</button>
        </ng-container>
        <button class="page-btn" [disabled]="currentPage === totalPages" (click)="changePage(currentPage + 1)">
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>

    </div>
  </div>
</div>